#
# All information at your chilly fingertips.
#
# Authors:
#   Tom Frost <tom@frosteddesign.com>
#
# Screenshots:
#   http://i.tomfro.st/U1Kov.png
#

# Dependencies
pmodload 'helper'

function prompt_frost_precmd {
  setopt LOCAL_OPTIONS
  unsetopt XTRACE KSH_ARRAYS

  if (( $+functions[git-info] )); then
    git-info
  fi

  if (( $+functions[python-info] )); then
    python-info
  fi
}

function prompt_frost_setup {
  setopt LOCAL_OPTIONS
  unsetopt XTRACE KSH_ARRAYS
  prompt_opts=(cr percent subst)

  # Load required functions.
  autoload -Uz add-zsh-hook
  autoload -Uz vcs_info

  # Add hook for calling vcs_info before each command.
  add-zsh-hook precmd prompt_frost_precmd

  _prompt_frost_nocolor="%{$terminfo[sgr0]%}"
  _prompt_frost_colors=(
    "${_prompt_frost_nocolor}%F{blue}"
    "${_prompt_frost_nocolor}%F{blue}%{$terminfo[bold]%}"
    "${_prompt_frost_nocolor}%F{green}"
    "${_prompt_frost_nocolor}%F{green}%{$terminfo[bold]%}"
    "${_prompt_frost_nocolor}%F{red}"
    "${_prompt_frost_nocolor}%F{red}%{$terminfo[bold]%}"
    "${_prompt_frost_nocolor}%F{yellow}"
    "${_prompt_frost_nocolor}%F{yellow}%{$terminfo[bold]%}"
  )

function prompt_debian_symbol {
  zmodload zsh/datetime
  local symbol=''
  local -r burger=$(printf "\xF0\x9F\x8D\x94")
  local -r coffee=$(printf "\xE2\x98\x95")
  local -r beer=$(printf "\xF0\x9F\x8D\xBA")
  local -r hour=$(strftime %k $EPOCHSECONDS)
  if (( $hour >= 8 && $hour < 16 )); then
      symbol=$coffee
  elif (( $hour >= 16 && $hour < 19 )); then
      symbol=$burger
  else
      symbol=$beer
  fi
  printf $symbol
}

function parse-hostname() {
    local fqhostname="%M"
    local hostname="%m"

#    if [[ ${fqhostname} =~ .*w2k\.fei.* ]] then;

       local len=${#hostname}
       local num=$(echo $hostname | grep -o '[0-9]\+')
       local numlen=${#num}
       local pos=$len - $numlen
       local site=$hostname[1,3]
       local host=$hostname[4,$pos]

       local out="${site}-${host}-${num}"

#       echo $out
#    else
        echo $hostname
##    fi
##echo $hostname
}


function emoji-clock() {
  # Add 15 minutes to the current time and save the value as $minutes.
  (( minutes = $(date '+%M') + 15 ))
  (( hour = $(date '+%I') + minutes / 60 ))
  # make sure minutes and hours don't exceed 60 nor 12 respectively
  (( minutes %= 60 )); (( hour %= 12 ))

  case $hour in
     0) clock="ðŸ•›"; [ $minutes -ge 30 ] && clock="ðŸ•§";;
     1) clock="ðŸ•"; [ $minutes -ge 30 ] && clock="ðŸ•œ";;
     2) clock="ðŸ•‘"; [ $minutes -ge 30 ] && clock="ðŸ•";;
     3) clock="ðŸ•’"; [ $minutes -ge 30 ] && clock="ðŸ•ž";;
     4) clock="ðŸ•“"; [ $minutes -ge 30 ] && clock="ðŸ•Ÿ";;
     5) clock="ðŸ•”"; [ $minutes -ge 30 ] && clock="ðŸ• ";;
     6) clock="ðŸ••"; [ $minutes -ge 30 ] && clock="ðŸ•¡";;
     7) clock="ðŸ•–"; [ $minutes -ge 30 ] && clock="ðŸ•¢";;
     8) clock="ðŸ•—"; [ $minutes -ge 30 ] && clock="ðŸ•£";;
     9) clock="ðŸ•˜"; [ $minutes -ge 30 ] && clock="ðŸ•¤";;
    10) clock="ðŸ•™"; [ $minutes -ge 30 ] && clock="ðŸ•¥";;
    11) clock="ðŸ•š"; [ $minutes -ge 30 ] && clock="ðŸ•¦";;
     *) clock="âŒ›";;
  esac
  echo $clock
}


  # Set editor-info params
  zstyle ':prezto:module:editor:info:completing' format '${_prompt_frost_colors[5]}...${_prompt_frost_nocolor}'
  zstyle ':prezto:module:editor:info:keymap:primary' format 'âž¤'
  zstyle ':prezto:module:editor:info:keymap:primary:overwrite' format 'â™º'
  zstyle ':prezto:module:editor:info:keymap:alternate' format 'âŸ'

  # Set get-info parameters
  zstyle ':prezto:module:git:info' verbose 'yes'
  zstyle ':prezto:module:git:info:action' format "${_prompt_frost_colors[1]}âˆ™${_prompt_frost_colors[7]}%s${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:added' format "${_prompt_frost_colors[4]}âœš${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:ahead' format "${_prompt_frost_colors[8]}âš¡${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:behind' format "${_prompt_frost_colors[8]}â†¯${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:branch' format "${_prompt_frost_colors[1]}âˆ™${_prompt_frost_colors[2]}%b${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:clean' format "${_prompt_frost_colors[3]}âœ”${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:commit' format "${_prompt_frost_colors[2]}%.7c${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:deleted' format "${_prompt_frost_colors[6]}âœ–${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:modified' format "${_prompt_frost_colors[7]}âœ±${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:renamed' format "${_prompt_frost_colors[6]}âžœ${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:stashed' format "${_prompt_frost_colors[7]}âœ­${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:unmerged' format "${_prompt_frost_colors[7]}â•${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:untracked' format "${_prompt_frost_colors[6]}â–ª${_prompt_frost_nocolor}"
  zstyle ':prezto:module:git:info:keys' format \
    'prompt' "${_prompt_frost_colors[1]}< %c%b%s${_prompt_frost_colors[1]}âˆ™%C%A%B%S%a%d%m%r%U%u${_prompt_frost_colors[1]} >â”€â”€â”€â”€â”€â”€â”€" \
    'rprompt' ''

  # Set python-info parameters
  zstyle ':prezto:module:python:info:virtualenv' format '< ${_prompt_frost_colors[2]}%v${_prompt_frost_nocolor} >â”€â”€â”€â”€â”€â”€â”€'

  # Get the time
  local time="%D{%H:%M:%S}"

  # Remote hosts change colors
  if [[ -n "$SSH_CLIENT"  ||  -n "$SSH2_CLIENT" ]]; then
    local host="${_prompt_frost_colors[8]}$(parse-hostname)" #SSH
  else
    local host="${_prompt_frost_colors[4]}$(parse-hostname)" # no SSH
  fi

  local user="%(!.${_prompt_frost_colors[6]}.${_prompt_frost_colors[4]})%n"
  local promptcolor='%(!.${_prompt_frost_colors[6]}.${_prompt_frost_nocolor})'

  # Define prompts.
  PROMPT="
${_prompt_frost_colors[1]}â•­â”€< ${user}${_prompt_frost_colors[1]}@${host} ${_prompt_frost_colors[1]}>â”€â”€â”€â”€â”€â”€â”€<${_prompt_frost_colors[7]}$(prompt_debian_symbol)${_prompt_frost_colors[1]} >â”€â”€â”€â”€â”€â”€â”€< ${_prompt_frost_colors[2]}%~${_prompt_frost_colors[1]} >â”€â”€â”€â”€â”€â”€â”€ "'${git_info[prompt]}'""'$python_info[virtualenv]'"< ${_prompt_frost_colors[2]}$time${_prompt_frost_colors[1]} $(emoji-clock) >â”€â—‡
â•°â”€${promptcolor}"'${editor_info[keymap]}'"${_prompt_frost_nocolor} "
  RPROMPT='${git_info[rprompt]}%(?..${_prompt_frost_colors[5]}%? â†µ${_prompt_frost_nocolor})'
  SPROMPT='zsh: correct ${_prompt_frost_colors[6]}%R${_prompt_frost_nocolor} to ${_prompt_frost_colors[4]}%r${_prompt_frost_nocolor} [nyae]? '
}

prompt_frost_setup "$@"
